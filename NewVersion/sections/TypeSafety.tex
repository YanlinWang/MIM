\begin{lemma}~\label{lemma0}
% $\textit{If } \mtype(m, I, J) = \overline{D} \rightarrow D, \textit{ and } \mbody(m, I, J) = \overline{x}.e, 
%  \textit{ then for some } J_0 \textit{ with } I <: J_0, \  \exists C <: D, \textit{ such that }  
%  \judgeewf {\overline{x}:\overline{D}, \kwthis:J_0} {e:C} $.
$\textit{If } \mbody(m, I, J) = (J', \overline{I_x} \; \overline{x}, I_e \; e), 
 \textit{ then for some } J_0 \textit{ with } I <: J_0, \  \exists I' <: I_e, \textit{ such that }  
 \judgeewf {\overline{x}:\overline{I_x}, \kwthis:J_0} {e : I'} $.
\end{lemma}

 \begin{proof}~\\
 $\textit{The base case: if } m \textit{ is defined in } I, \textit{ then it is easy since } m 
 \textit{ is defined in } I \textit{ and } 
 \judgeewf {\overline{x}:\overline{I_x}, \kwthis : I} {e : I_e}, \textit{by the rule \textsc{(T-Method)}}.
 \textit{The induction step is also straightforward.} 
 $ 
 \end{proof}

\textcolor{red}{
\begin{lemma}[Method Type Preservation]~\label{lemma2_new}
$\textit{If } \mbody(m, I_0, J_0) = (K, \overline{I_x}\ \_, I_e\ \_)$, $\mbody(m, I'_0, J_0) = (K', \overline{I'_x}\ \_, I'_e\ \_) \textit{ for some }I'_0 \subtype I_0, \textit{ then }
\overline{I'_x} = \overline{I_x}$ $\textit{and } I'_e = I_e.$
\end{lemma}}
\begin{proof}
	
Trivial for the case $I'_0 = I_0$. And since the lemma has transitivity on subtyping, it suffices to prove the following cases and rely on induction, where we can suppose that $I'_0$ directly extends $I_0$.

Suppose that $$\mostSpecific(m, I_0, J_0) = \{I\}$$ $$\mostSpecificOverride(m, I_0, I) = \{K\}$$

\textbf{(1) The body of $I'_0$ does not contain $m$.} Trivial because $\mbody(m, I_0, J_0) = \mbody(m, I'_0, J_0)$. \haoyuan{Non-trivial. m may be inherited from other super types. TODO.}

\textbf{(2) $m \in \overrideSet(I'_0, I'_0)$.} In that case $I'_0$ defines an original method $m$.
 So
$$\mostSpecific(m, I'_0, J_0) = \{I'_0\}$$ $$\mostSpecificOverride(m, I'_0, I'_0) = \{I'_0\}$$
Hence $\mbody(m, I'_0, J_0)$ returns the original $m$ from $I'_0$. By $\textsc{(T-Intf)}$, we know that $\canOverride(m, I'_0, I)$ holds, which means that $I'_0$ has the same type as $I$ for $m$. On the other hand, from $\textsc{(T-Method)}$ and $\textsc{(T-AbsMethod)}$, the type of $m$ is also preserved between $I$ and $K$ (method override needs to keep the type). Finally $\mbody(m, I'_0, J_0)$ has the same type as $\mbody(m, I_0, J_0)$.

\textbf{(3) $m \in \overrideSet(I'_0, I)$.} Similar to (2), $I$ and $K$ have the same type for $m$. Moreover, $\textsc{(T-Method)}$ and $\textsc{(T-AbsMethod)}$ also ensure that $I'_0$ and $I$ have the same type for $m$. \haoyuan{But findOrigin may no longer be I.}

\textbf{(4) $m \in \overrideSet(I'_0, J)$ for some other $J$.} Same as (1). Such an $m$ does not affect the result of $\mbody$.
%Straight induction on the derivation of $J \subtype I$. Whether $m$ is defined in $J$ or not, $\mtype(m, J)$ should 
%be the same as $\mtype(m, K)$ where $J \; \kwextends \; K \{...\}$.
\end{proof}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lemma}[Term Substitution Preserves Typing]~\label{lemma1}
$\textit{If } \ \judgeewf {\Gamma, \ \overline{x}:\overline{I_x}} { e : I } \textit{ , and }
\judgeewf {\Gamma} {\overline{y}:\overline{I_y}} \textit{ where } \overline{I_y} \subtype \overline{I_x}
\textit{, then } \judgeewf {\Gamma} {[\overline{y}/\overline{x}]e : I'} \textit{ for some } I' \subtype I.
$

\begin{proof}~\\
\noindent \textbf{Case Var.}
$ e = x \quad I = \Gamma(x) $. \\
If $x \notin \overline{x}$, then the conclusion is immediate, since $[\overline{y}/\overline{x}]x = x$.
On the other hand, if $x = x_i$ and $I = {I_x}_i$, then since $[\overline{y}/\overline{x}]x = [\overline{y}/\overline{x}]x_i = y_i$,
letting $I' = {I_y}_i$ finishes the case.

\noindent \textbf{Case New.}
$e = \new I$ and there are no term for substitution, the conclusion is obvious.

\begin{comment}
\noindent \textbf{Case Invk.}
$ e = e_0.m(\overline{e}) \quad
  \judgeewf {\Gamma, \overline{x}:\overline{I_x}} {e_0 : I_0} $
$$ mtype(m, I_0) = \overline{I_e} \rightarrow J $$
$$ \judgeewf {\Gamma, \overline{x}:\overline{I_x}} {\overline{e}:\overline{I}} \quad
    \overline{I} \subtype \overline{I_e} $$
By induction hypothesis, there are some $I_0'$ and $\overline{I_e'}$ such that
    $$ \judgeewf {\Gamma} {[\overline{y}/\overline{x}]e_0 : I_0'} \quad 
        I_0' \subtype I_0 $$
    $$ \judgeewf {\Gamma} {[\overline{y}/\overline{x}]\overline{e} : \overline{I_e'}} \quad  
        \overline{I_e'} \subtype \overline{I}$$    
By lemma~\ref{lemma2}, 
    $mtype(m, I_0') = \overline{I_e} \rightarrow J$.
    
\noindent Then $\overline{I_e'} \subtype \overline{I_e}$ by the transitivity of $\subtype$.
Therefore, by the rule \textsc{(T-Invk)}, 
    $\judgeewf {\Gamma} {[\overline{y}/\overline{x}]e_0.m([\overline{y}/\overline{x}]\overline{e}) : J}$.

\noindent \textbf{Case PathInvk.}
$ e = e_0.I::m(\overline{e}) $ and proof is similar as case Var.

\noindent \textbf{Case SuperInvk.}
$ e = \kwsuper.I::m(\overline{e}) $ \\
Suppose $\judgeewf {\Gamma} {\kwthis : I_0}$, the following proof should be similar as case Var.
\end{comment}

\noindent\textcolor{red}{\textbf{Case PathInvk.} $e = e_0.J_0?m(\overline{e})$. By \textsc{(T-PathInvk)}, suppose}
	$$\textcolor{red}{\judgeewf {\Gamma, \overline{x}:\overline{I_x}} {e_0 : I_0} \quad I_0 \subtype J_0}$$
	$$\textcolor{red}{\mbody(m, I_0, J_0) = (\_, \overline{J}\ \_, I\ \_)}$$
	$$\textcolor{red}{\judgeewf {\Gamma, \overline{x}:\overline{I_x}} {\overline{e} : \overline{I_e}} \quad 
	  \overline{I_e} \subtype \overline{J} \quad \judgeewf {\Gamma, \overline{x}:\overline{I_x}} {e : I}}$$
\textcolor{red}{By induction hypothesis, there are some $I'_0$ and some $\overline{I'_e}$ such that}
	$$\textcolor{red}{\judgeewf {\Gamma} {[\overline{y}/\overline{x}]e_0 : I_0'} \quad I_0' \subtype I_0 \subtype J_0}$$
	$$\textcolor{red}{\judgeewf {\Gamma} {[\overline{y}/\overline{x}]\overline{e} : \overline{I_e'}} \quad 
	  \overline{I_e'} \subtype \overline{I_e} \subtype \overline{J}}$$   
\textcolor{red}{By lemma~\ref{lemma2_new}, if $[\overline{y}/\overline{x}]e$ is well typed,}
	$$\textcolor{red}{\mbody(m, I'_0, J_0) = (\_, \overline{J}\ \_, I\ \_)}$$
\textcolor{red}{Therefore, by the rule \textsc{(T-Invk)}, 
	$\judgeewf {\Gamma} {[\overline{y}/\overline{x}]e_0.m([\overline{y}/\overline{x}]\overline{e}) : I}$.}



\end{proof}

\end{lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\subsubsection{Proof for Theorem~\ref{theorem_subject}}
\begin{proof} ~\\
\noindent\textcolor{red}{\textbf{Case Invk.} TODO. By t-invk and t-intf.}

\noindent\textcolor{red}{\textbf{Case PathInvk.} Let}
  $$\textcolor{red}{e = (\angl{J}\new{I}).K?m(\overline{v}) \quad \judgeewf {\Gamma} {e : I_e}}$$
  $$\textcolor{red}{e' = \angl{I_e}[\overline{\angl{I_x}} \overline{v}/\overline{x}, \angl{I_0}\new{I}/\kwthis]e_0}$$
  $$\textcolor{red}{\mbody(m, I, K) = (I_0, \overline{I_x} \; \overline{x}, I_e \; e_0)}$$
\textcolor{red}{Since $\mbody(m, I, K)$ is defined, the definition of $\mbody$ ensures that $I \subtype I_0$. And since $e$ is well typed, by \textsc{(T-PathInvk)},}
  $$\textcolor{red}{\judgeewf {\Gamma} {\overline{v} : \overline{I_v} \subtype \overline{I_x}}}$$

\noindent \textcolor{red}{By \textsc{(T-New)}, \textsc{(T-Anno)} and lemma~\ref{lemma0},}
  $$\textcolor{red}{\judgeewf {\Gamma} {\angl{I_0}\new{I} : I} \quad \judgeewf {\Gamma, \overline{x} : \overline{I_x}, \kwthis : I_0} {e_0 : I_{e_0} \subtype I_e}}$$

\noindent \textcolor{red}{Hence by lemma~\ref{lemma1}, the substitution preserves typing, thus}
  $$\textcolor{red}{\judgeewf {\Gamma} {[\overline{\angl{I_x}} \overline{v}/\overline{x}, \angl{I_0}\new{I}/\kwthis]e_0 : I'_{e_0} \subtype I_{e_0} \subtype I_e}}$$
\noindent \textcolor{red}{By \textsc{(T-Anno)}, $\judgeewf {\Gamma} {e' : I'_{e_0} \subtype I_e}$.}

\begin{comment}
\noindent \textbf{Case Invk.} 
let \[ e = \angl{J}\new I.m(\overline{\angl{I_e}}\overline{e}) \] 
Suppose \[ \mbody(m, I, J) = (J', \overline{I_x} \; \overline{x}, I_{e_0} \; e_0) \] 
then \[ e' =  [\overline{\angl{I_x}} \overline{e}/\overline{x}, \; \angl{J}\new I/\kwthis ] e_0 \] 
By rules \textsc{(T-New)} and \textsc{(T-Invk)}, 
  \[ \judgeewf \Gamma {\new I:I} \quad 
     \mtype(m, I, J) = \overline{I_x} \rightarrow I_{e_0} \quad 
     \judgeewf \Gamma {\overline{e} : \overline{I_e'}} \quad
     \overline{I_e'} \subtype \overline{I_x} \quad
     \textit{, for some } \; \overline{I_e'}
  \]
By Lemma~\ref{lemma0},
    \[
    \judgeewf {\Gamma, \overline{x}:\overline{I_x}, \kwthis:J_0} {e_0:I_f} \textit{, for some } J \subtype J_0 \textit{ and } I_f \subtype I_{e_0}
    \]
By Lemma~\ref{lemma1},
    \[
    \judgeewf {\Gamma} {[\overline{\angl{I_x}} \overline{e}/\overline{x}, \; \angl{J}\new I/\kwthis ] e_0  :  I_g} \textit{, for some } I_g \subtype I_f 
    \]
So $I_g <: I_{e_0}$, finally just let $I' = I_g$.

\noindent \textbf{Case PathInvk.}
let \[ e = \angl{J}\new I.K::m(\overline{\angl{I_e}} \overline{e}) \]  
Suppose \[ \mbody(m, I, K) = (J', \overline{I_x} \; \overline{x}, I_{e_0} \; e_0) \] 
then \[ e' =  [\overline{\angl{I_x}} \overline{e}/\overline{x}, \; \angl{K}\new I/\kwthis ] e_0 \] 
By rules \textsc{(T-New)} and \textsc{(T-Invk)}, 
  \[ \judgeewf \Gamma {\new I:I} \quad 
     \mtype(m, I, K) = \overline{I_x} \rightarrow I_{e_0} \quad 
     \judgeewf \Gamma {\overline{e} : \overline{I_e'}} \quad
     \overline{I_e'} \subtype \overline{I_x} \quad
     \textit{, for some } \; \overline{I_e'}
  \]
By Lemma~\ref{lemma0},
    \[
    \judgeewf {\Gamma, \overline{x}:\overline{I_x}, \kwthis:J_0} {e_0:I_f} \textit{, for some } K \subtype J_0 \textit{ and } I_f \subtype I_{e_0}
    \]
By Lemma~\ref{lemma1},
    \[
    \judgeewf {\Gamma} {[\overline{\angl{I_x}} \overline{e}/\overline{x}, \; \angl{K}\new I/\kwthis ] e_0  :  I_g} \textit{, for some } I_g \subtype I_f 
    \]
So $I_g <: I_{e_0}$, finally just let $I' = I_g$.

\noindent \textbf{Case Super-Invk.}
let \[ e = \kwsuper.K::m(\overline{\angl{I_e}} \overline{e}) \]   
Suppose \[ \mbody(m, K, K) = (J', \overline{I_x} \; \overline{x}, I_{e_0} \; e_0) \] 
then \[ e' =  [\overline{\angl{I_x}} \overline{e}/\overline{x}] e_0 \] 
By rules \textsc{(T-New)} and \textsc{(T-Invk)}, 
  \[ 
     \mtype(m, K, K) = \overline{I_x} \rightarrow I_{e_0} \quad 
     \judgeewf \Gamma {\overline{e} : \overline{I_e'}} \quad
     \overline{I_e'} \subtype \overline{I_x} \quad
     \textit{, for some } \; \overline{I_e'}
  \]
By Lemma~\ref{lemma0},
    \[
    \judgeewf {\Gamma, \overline{x}:\overline{I_x}, \kwthis:J_0} {e_0:I_f} \textit{, for some } K \subtype J_0 \textit{ and } I_f \subtype I_{e_0}
    \]
By Lemma~\ref{lemma1},
    \[
    \judgeewf {\Gamma} {[\overline{\angl{I_x}} \overline{e}/\overline{x} ] e_0  :  I_g} \textit{, for some } I_g \subtype I_f 
    \]
So $I_g <: I_{e_0}$, finally just let $I' = I_g$.

\end{comment}
\end{proof}

\subsubsection{Proof for Theorem~\ref{theorem_progress}}
\begin{proof}~\\
\noindent \textcolor{red}{TODO. t-pathinvk. t-new. remember canInstantiate() to ensure $e_0$ is not empty.}
\end{proof}